{"version":3,"sources":["../tools/data_loader.ts"],"names":["splitTrainToTrainAndTest","state","ghost","fileExists","intentsFiles","directoryListing","file","intentData","readFileAsObject","upsertFile","JSON","stringify","undefined","tests","intentDatas","languages","Object","keys","utterances","lang","test_utts","_","sampleSize","floor","length","train_utts","filter","s","includes","concat","map","id","crypto","createHash","update","digest","conditions","contexts","name","utterance","context","getTrainTestDatas","embedder","model_name","vectorized_train","vectorized_test","trainDatas","testDatas","train","test","rawTrain","rawTest","jsonData","push","testFileExist","console","log","intents","uniqBy","o","number2intents","intent2number","zipObject","values","entry","utt_emb","embed","utt","label","parseInt","intent","config","readFileAsString","parse"],"mappings":"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","sourceRoot":"/mnt/Documents/Projets/BotPress/botpress/modules/visualisation/src/backend","sourcesContent":["import crypto from 'crypto'\nimport _ from 'lodash'\n\nimport { BotState, Data, RawData, Test } from '../backend/typings'\n\nexport async function splitTrainToTrainAndTest(state: BotState) {\n  // Backup the real intent folder\n  debugger\n  if (!(await state.ghost.fileExists('./', 'raw_intents'))) {\n    const intentsFiles = await state.ghost.directoryListing('./intents', '*.json')\n    for (const file of intentsFiles) {\n      const intentData = await state.ghost.readFileAsObject<RawData>('./intents', file)\n      await state.ghost.upsertFile('./raw_intents', file, JSON.stringify(intentData, undefined, 2))\n    }\n  }\n  // In the new\n  const intentsFiles = await state.ghost.directoryListing('./raw_intents', '*.json')\n  let tests: Test[] = []\n  for (const file of intentsFiles) {\n    const intentDatas = await state.ghost.readFileAsObject<RawData>('./raw_intents', file)\n    const languages = Object.keys(intentDatas.utterances)\n    for (const lang of languages) {\n      const test_utts = _.sampleSize(intentDatas.utterances[lang], _.floor(intentDatas.utterances[lang].length / 4))\n      const train_utts = intentDatas.utterances[lang].filter(s => !test_utts.includes(s))\n      intentDatas.utterances[lang] = train_utts\n      tests = tests.concat(\n        test_utts.map(s => {\n          return {\n            id: crypto\n              .createHash('md5')\n              .update(s)\n              .digest('hex'),\n            conditions: [\n              ['context', 'is', intentDatas.contexts[0]],\n              ['intent', 'is', intentDatas.name]\n            ],\n            utterance: s,\n            context: intentDatas.contexts[0]\n          } as Test\n        })\n      )\n    }\n    await state.ghost.upsertFile('./intents', file, JSON.stringify(intentDatas, undefined, 2))\n  }\n  await state.ghost.upsertFile('./', 'nlu-tests.json', JSON.stringify(tests, undefined, 2))\n}\nexport async function getTrainTestDatas(state: BotState) {\n  debugger\n  if (\n    (await state.ghost.fileExists(`./datas/${state.embedder.model_name}`, 'test_set.json')) &&\n    (await state.ghost.fileExists(`./datas/${state.embedder.model_name}`, 'train_set.json'))\n  ) {\n    const vectorized_train: Data[] = await state.ghost.readFileAsObject<Data[]>(\n      `./datas/${state.embedder.model_name}`,\n      'train_set.json'\n    )\n    const vectorized_test: Data[] = await state.ghost.readFileAsObject<Data[]>(\n      `./datas/${state.embedder.model_name}`,\n      'test_set.json'\n    )\n    state.trainDatas = vectorized_train\n    state.testDatas = vectorized_test\n    return { train: vectorized_train, test: vectorized_test }\n  }\n  const rawTrain: RawData[] = []\n  let rawTest: Test[] = []\n\n  const intentsFiles = await state.ghost.directoryListing('./intents', '*.json')\n  for (const file of intentsFiles) {\n    const jsonData = await state.ghost.readFileAsObject<RawData>('./intents', file)\n    rawTrain.push(jsonData)\n  }\n\n  const testFileExist = await state.ghost.fileExists('./', 'nlu-tests.json')\n  if (testFileExist) {\n    rawTest = await state.ghost.readFileAsObject<Test[]>('./', 'nlu-tests.json')\n  } else {\n    console.log('No test file found : You need a test file to run confusion matrix !')\n    console.log('Running a splitter to create 1/4 of training datas to test')\n    await splitTrainToTrainAndTest(state)\n    rawTest = await state.ghost.readFileAsObject<Test[]>('./', 'nlu-tests.json')\n  }\n\n  const intents = _.uniqBy(rawTrain, 'name').map(o => o.name)\n  const number2intents: any = { ...intents }\n  const intent2number = _.zipObject(Object.values(number2intents), Object.keys(number2intents))\n\n  const vectorized_test: Data[] = []\n  const vectorized_train: Data[] = []\n\n  for (const entry of rawTest) {\n    const utt_emb = await state.embedder.embed(entry.utterance)\n    vectorized_test.push({\n      utt: entry.utterance,\n      utt_emb,\n      label: parseInt(intent2number[entry.conditions[0][2]]),\n      intent: entry.conditions[1][2]\n    } as Data)\n  }\n\n  const config = await state.ghost.readFileAsString('./', 'bot.config.json')\n  const lang = JSON.parse(config).languages[0]\n  console.log('LANG', JSON.parse(config).id, lang)\n  for (const entry of rawTrain) {\n    // console.log(entry.utterances)\n    // console.log(entry.utterances[lang])\n    for (const utt of entry.utterances[lang]) {\n      const utt_emb = await state.embedder.embed(utt)\n      vectorized_train.push({\n        utt,\n        utt_emb,\n        label: parseInt(intent2number[entry.name]),\n        intent: entry.name\n      } as Data)\n    }\n  }\n  console.log('going to write')\n  await state.ghost.upsertFile(\n    `./datas/${state.embedder.model_name}`,\n    'test_set.json',\n    JSON.stringify(vectorized_test, undefined, 2)\n  )\n  console.log('written test')\n  await state.ghost.upsertFile(\n    `./datas/${state.embedder.model_name}`,\n    'train_set.json',\n    JSON.stringify(vectorized_train, undefined, 2)\n  )\n  console.log('written train')\n  state.trainDatas = vectorized_train\n  state.testDatas = vectorized_test\n  return { train: vectorized_train, test: vectorized_test }\n}\n"]}