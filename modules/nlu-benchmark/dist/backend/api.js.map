{"version":3,"sources":["api.ts"],"names":["spawn","require","bp","router","http","createRouterForBot","importOnnxModels","model_name","model_cache","path","join","dl_and_export","stdout","on","data","console","log","stderr","error","message","code","importTfModels","cleanPytorchCache","listAvailablesModelsName","models_path","fse","readdir","postRunTests","datas","get","req","res","send","post","body","run_embedding_test","model","dataset","run_intent_test","run_qa_test"],"mappings":"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","sourceRoot":"/mnt/Documents/Projets/BotPress/botpress/modules/nlu-benchmark/src/backend","sourcesContent":["import * as sdk from 'botpress/sdk'\nimport { getAppDataPath } from 'common/utils'\nimport fse from 'fs-extra'\nimport path from 'path'\n\ninterface ModelsTests {\n  model_name: string\n  test_embeddings: boolean\n  test_intents: boolean\n  test_qa: boolean\n}\n\nconst { spawn } = require('child_process')\nexport default async (bp: typeof sdk) => {\n  const router = bp.http.createRouterForBot('nlu-benchmark')\n\n  const importOnnxModels = async (model_name: string) => {\n    const model_cache = path.join(getAppDataPath(), 'deep_models', 'embedders', 'onnx', model_name)\n    const dl_and_export = spawn('python', [\n      './onnx_exporter.py',\n      '--model',\n      model_name,\n      '--framework',\n      'pt', // Can be tf for tensorflow\n      // '--opset', 11,  // The version of onnx operations sets\n      '--check-loading', // Check if exported model can be reloaded in pytorch\n      '--use-external-format', //\n      path.join(model_cache, `${model_name}.onnx`)\n    ])\n\n    dl_and_export.stdout.on('data', data => {\n      console.log(`stdout: ${data}`)\n    })\n\n    dl_and_export.stderr.on('data', data => {\n      console.log(`stderr: ${data}`)\n    })\n\n    dl_and_export.on('error', error => {\n      console.log(`error: ${error.message}`)\n    })\n\n    dl_and_export.on('close', code => {\n      console.log(`exporting onnx model exited with code ${code}`)\n    })\n  }\n  const importTfModels = async (model_name: string) => {\n    const model_cache = path.join(getAppDataPath(), 'deep_models', 'tensorflow', model_name)\n    const dl_and_export = spawn('python', ['./tf_exporter.py', '-m', model_name, '--cache', model_cache])\n\n    dl_and_export.stdout.on('data', data => {\n      console.log(`stdout: ${data}`)\n    })\n\n    dl_and_export.stderr.on('data', data => {\n      console.log(`stderr: ${data}`)\n    })\n\n    dl_and_export.on('error', error => {\n      console.log(`error: ${error.message}`)\n    })\n\n    dl_and_export.on('close', code => {\n      console.log(`exporting onnx model exited with code ${code}`)\n    })\n  }\n\n  const cleanPytorchCache = async () => {}\n\n  const listAvailablesModelsName = async () => {\n    const models_path = path.join(getAppDataPath(), 'cache', 'deep_models', 'embedders', 'tensorflow')\n    return fse.readdir(models_path)\n  }\n\n  const postRunTests = async datas => {\n    console.log(datas)\n    // Load models returned by the checkbox\n    // Launch each test and give live results\n  }\n\n  router.get('/modelsName', async (req, res) => {\n    res.send((await listAvailablesModelsName()) as string[])\n  })\n\n  router.post('/runTests', async (req, res) => {\n    res.send(await postRunTests(req.body))\n  })\n\n  router.post('/importOnnxModels', async (req, res) => {\n    res.send(await importOnnxModels(req.body))\n  })\n  router.post('/importTfModels', async (req, res) => {\n    res.send(await importTfModels(req.body))\n  })\n  const run_embedding_test = async (model: any, dataset: string[]) => {}\n  const run_intent_test = async (model: any, dataset: string[]) => {}\n  const run_qa_test = async (model: any, dataset: string[]) => {}\n}\n"]}